#!/bin/bash

# ==============================================================================
# CLIProxy Ultimate Installer for macOS
# Includes: Homebrew, Go, Git, CLIProxyAPIPlus, and Shortcuts
# ==============================================================================

# --- Colors ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# --- Helper Functions ---

check_brew() {
    if command -v brew &> /dev/null; then
        echo -e "${GREEN}[OK] Homebrew is already installed.${NC}"
        return 0
    else
        return 1
    fi
}

install_brew() {
    echo -e "${YELLOW}Installing Homebrew...${NC}"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    if [[ -f "/opt/homebrew/bin/brew" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
    if [[ -f "/usr/local/bin/brew" ]]; then
        eval "$(/usr/local/bin/brew shellenv)"
    fi
}

install_dependencies() {
    if ! check_brew; then
        echo -e "${RED}[Error] Homebrew is required to install Git and Go.${NC}"
        echo "Please run option 1 (Install Homebrew) first."
        return 1
    fi

    echo -e "${YELLOW}Updating Homebrew...${NC}"
    brew update

    echo -e "${YELLOW}Installing/Checking Git...${NC}"
    brew install git || echo "Git already installed or updated."

    echo -e "${YELLOW}Installing/Checking Go...${NC}"
    brew install go || echo "Go already installed or updated."

    echo -e "${GREEN}[OK] Dependencies ready.${NC}"
}

setup_shortcuts() {
    SHELL_CONFIG="$HOME/.zshrc"
    if [ "$SHELL" == "/bin/bash" ]; then
        SHELL_CONFIG="$HOME/.bashrc"
    fi

    echo -e "${YELLOW}Adding shortcuts (cp-login, cp-start) to $SHELL_CONFIG...${NC}"

    # Remove old aliases if they exist to prevent duplicates
    sed -i '' '/alias cp-login/d' "$SHELL_CONFIG" 2>/dev/null || true
    sed -i '' '/alias cp-start/d' "$SHELL_CONFIG" 2>/dev/null || true
    sed -i '' '/alias cp-update/d' "$SHELL_CONFIG" 2>/dev/null || true
    sed -i '' '/alias cp-stop/d' "$SHELL_CONFIG" 2>/dev/null || true

    # Add new aliases
    echo "" >> "$SHELL_CONFIG"
    echo "# CLIProxy Shortcuts" >> "$SHELL_CONFIG"
    echo "alias cp-login=\"$HOME/.cli-proxy-api/scripts/login.sh\"" >> "$SHELL_CONFIG"
    echo "alias cp-start=\"$HOME/.cli-proxy-api/scripts/start.sh\"" >> "$SHELL_CONFIG"
    echo "alias cp-update=\"curl -sL https://raw.githubusercontent.com/khmuhtadin/cliproxy-installer/main/install | bash -s -- -update\"" >> "$SHELL_CONFIG"
    echo "alias cp-stop=\"$HOME/.cli-proxy-api/scripts/stop.sh\"" >> "$SHELL_CONFIG"

    echo -e "${GREEN}[OK] Shortcuts added!${NC}"
}

install_cliproxy() {
    if ! command -v go &> /dev/null; then
        echo -e "${RED}[Error] Go is not found!${NC}"
        echo "Please run option 2 or 4 to install dependencies first."
        exit 1
    fi

    echo -e "${YELLOW}>>> Starting CLIProxy Installation...${NC}"

    BIN_DIR="$HOME/bin"
    CONFIG_DIR="$HOME/.cli-proxy-api"
    SCRIPTS_DIR="$CONFIG_DIR/scripts"

    mkdir -p "$BIN_DIR"
    mkdir -p "$CONFIG_DIR"
    mkdir -p "$SCRIPTS_DIR"
    STATIC_DIR="$CONFIG_DIR/static"
    mkdir -p "$STATIC_DIR"

    # Copy enhanced dashboard
    echo "ðŸ“Š Installing enhanced dashboard..."
    DASHBOARD_SRC="$(dirname "$0")/assets/static/dashboard.html"
    if [ -f "$DASHBOARD_SRC" ]; then
        cp "$DASHBOARD_SRC" "$STATIC_DIR/dashboard.html"
        echo -e "${GREEN}[OK] Dashboard installed from local assets${NC}"
    else
        # Fallback: try to download from GitHub
        if curl -fsSL "https://raw.githubusercontent.com/khmuhtadin/cliproxy-installer/main/assets/static/dashboard.html" -o "$STATIC_DIR/dashboard.html" 2>/dev/null; then
            echo -e "${GREEN}[OK] Dashboard downloaded from GitHub${NC}"
        else
            echo -e "${YELLOW}[!] Could not install dashboard${NC}"
        fi
    fi

    # Install cp-db command
    echo "ðŸ”® Installing cp-db shortcut..."
    cat > "/tmp/cp-db" <<'EOF'
#!/bin/bash

# CLIProxy Dashboard Launcher
# Checks if server is running, starts if needed, then opens dashboard

DASHBOARD_URL="http://localhost:8317/dashboard.html"
PORT=8317

echo "ðŸ”® CLIProxy Dashboard Launcher"
echo ""

# Check if server is already running
if lsof -i :$PORT -sTCP:LISTEN -t >/dev/null 2>&1; then
    PID=$(lsof -i :$PORT -sTCP:LISTEN -t)
    echo "âœ… Server already running (PID: $PID)"
else
    echo "âš ï¸  Server not running, starting now..."
    
    # Determine start command
    CP_START_CMD=""
    if command -v cp-start >/dev/null 2>&1; then
        CP_START_CMD="cp-start"
    elif [ -x "$HOME/.cli-proxy-api/scripts/start.sh" ]; then
        CP_START_CMD="$HOME/.cli-proxy-api/scripts/start.sh"
    fi

    if [ -n "$CP_START_CMD" ]; then
        "$CP_START_CMD" &
        echo "â³ Waiting for server to start..."
        
        # Wait up to 10 seconds for server to start
        for i in {1..10}; do
            sleep 1
            if lsof -i :$PORT -sTCP:LISTEN -t >/dev/null 2>&1; then
                PID=$(lsof -i :$PORT -sTCP:LISTEN -t)
                echo "âœ… Server started successfully (PID: $PID)"
                break
            fi
            if [ $i -eq 10 ]; then
                echo "âŒ Server failed to start. Please check logs."
                exit 1
            fi
        done
    else
        echo "âŒ cp-start command not found. Please install CLIProxy first."
        exit 1
    fi
fi

echo ""
echo "ðŸŒ Opening dashboard: $DASHBOARD_URL"
echo ""

# Open dashboard in default browser
if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    open "$DASHBOARD_URL"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    # Linux
    if command -v xdg-open >/dev/null 2>&1; then
        xdg-open "$DASHBOARD_URL"
    elif command -v gnome-open >/dev/null 2>&1; then
        gnome-open "$DASHBOARD_URL"
    else
        echo "Please open manually: $DASHBOARD_URL"
    fi
else
    echo "Please open manually: $DASHBOARD_URL"
fi

echo "âœ¨ Dashboard opened successfully!"
EOF
    sudo mv /tmp/cp-db /usr/local/bin/cp-db
    sudo chmod +x /usr/local/bin/cp-db
    echo -e "${GREEN}[OK] cp-db installed${NC}"


    # Clone & Build
    TEMP_DIR=$(mktemp -d)
    echo "Cloning repository..."
    if ! git clone --depth 1 https://github.com/router-for-me/CLIProxyAPIPlus.git "$TEMP_DIR"; then
        echo -e "${RED}[Error] Failed to clone repository${NC}"
        rm -rf "$TEMP_DIR"
        exit 1
    fi

    echo "Building binary..."
    cd "$TEMP_DIR"
    if ! go build -o cliproxyapi-plus ./cmd/server; then
        echo -e "${RED}[Error] Failed to build binary${NC}"
        cd -
        rm -rf "$TEMP_DIR"
        exit 1
    fi
    mv -f cliproxyapi-plus "$BIN_DIR/cliproxyapi-plus"
    cd -
    rm -rf "$TEMP_DIR"

    echo -e "${GREEN}[OK] Binary built and installed successfully.${NC}"

    # Config - Only create if it doesn't exist to preserve user settings
    if [ ! -f "$CONFIG_DIR/config.yaml" ]; then
        cat > "$CONFIG_DIR/config.yaml" <<EOF
port: 8317
auth-dir: "$CONFIG_DIR"
api-keys:
  - "sk-dummy"
quota-exceeded:
  switch-project: true
  switch-preview-model: true
EOF
        echo -e "${GREEN}[OK] Created config.yaml${NC}"
    else
        echo -e "${YELLOW}[!] config.yaml exists, preserving user settings${NC}"
    fi

    # Helper Scripts
    cat > "$SCRIPTS_DIR/start.sh" <<EOF
#!/bin/bash
echo "Starting CLIProxy on http://localhost:8317"
"$BIN_DIR/cliproxyapi-plus" --config "$CONFIG_DIR/config.yaml"
EOF
    chmod +x "$SCRIPTS_DIR/start.sh"

    cat > "$SCRIPTS_DIR/login.sh" <<EOF
#!/bin/bash
BINARY="$BIN_DIR/cliproxyapi-plus"
CONFIG="$CONFIG_DIR/config.yaml"
clear
echo "1. Antigravity (Claude/Gemini)"
echo "2. GitHub Copilot"
echo "3. Gemini CLI"
echo "4. Codex"
echo "5. Claude"
echo "6. Qwen"
echo "7. iFlow"
echo "8. Kiro"
read -p "Select provider (1-8): " c
case \$c in
  1) "\$BINARY" --config "\$CONFIG" -antigravity-login ;;
  2) "\$BINARY" --config "\$CONFIG" -github-copilot-login ;;
  3) "\$BINARY" --config "\$CONFIG" -login ;;
  4) "\$BINARY" --config "\$CONFIG" -codex-login ;;
  5) "\$BINARY" --config "\$CONFIG" -claude-login ;;
  6) "\$BINARY" --config "\$CONFIG" -qwen-login ;;
  7) "\$BINARY" --config "\$CONFIG" -iflow-login ;;
  8) "\$BINARY" --config "\$CONFIG" -kiro-login ;;
  *) echo "Invalid" ;;
esac
EOF
    chmod +x "$SCRIPTS_DIR/login.sh"
    # Stop Script
    cat > "$SCRIPTS_DIR/stop.sh" <<'EOF'
#!/bin/bash
# Stop CLIProxy server
PORT=8317

echo "Stopping CLIProxy server on port $PORT..."

# Find PID listening on port
if lsof -i :$PORT -sTCP:LISTEN -t >/dev/null 2>&1; then
    PID=$(lsof -i :$PORT -sTCP:LISTEN -t)
    echo "Found server process (PID: $PID)"
    kill $PID
    
    # Wait for process to stop
    sleep 1
    if lsof -i :$PORT -sTCP:LISTEN -t >/dev/null 2>&1; then
         echo "Force killing..."
         kill -9 $PID
    fi
    echo "Server stopped successfully"
else
    echo "Server is not running on port $PORT"
fi
EOF
    chmod +x "$SCRIPTS_DIR/stop.sh"

    # Droid Config Injection
    DROID_FILE="$HOME/.factory/config.json"
    mkdir -p "$(dirname "$DROID_FILE")"

    # Define target models
    cat > "/tmp/cliproxy_new_models.json" <<EOF
{
    "custom_models": [
        { "model_display_name": "GPT-OSS 120B Medium [Antigravity]", "model": "gpt-oss-120b-medium", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "GPT-OSS 120B Large [Antigravity]", "model": "gpt-oss-120b-large", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Opus 4.5 Thinking [Antigravity]", "model": "gemini-claude-opus-4-5-thinking", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Sonnet 4.5 Thinking [Antigravity]", "model": "gemini-claude-sonnet-4-5-thinking", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Sonnet 4.5 [Antigravity]", "model": "gemini-claude-sonnet-4-5", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Gemini 3 Pro [Antigravity]", "model": "gemini-3-pro-preview", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Opus 4.5 [Copilot]", "model": "claude-opus-4.5", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "GPT-5 Mini [Copilot]", "model": "gpt-5-mini", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "GPT-5.1 Codex Max [Codex]", "model": "gpt-5.1-codex-max", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Gemini 3 Ultra [Antigravity]", "model": "gemini-3-ultra-preview", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Llama 4 405B [Meta]", "model": "llama-4-405b-instruct", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Nano Banana [Local]", "model": "nano-banana-v1", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Gemini 2.5 Pro [Gemini]", "model": "gemini-2.5-pro", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Qwen3 Coder Plus [Qwen]", "model": "qwen3-coder-plus", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "GLM 4.6 [iFlow]", "model": "glm-4.6", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Opus 4.5 [Kiro]", "model": "kiro-claude-opus-4.5", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Sonnet 4.5 [Kiro]", "model": "kiro-claude-sonnet-4.5", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Sonnet 4 [Kiro]", "model": "kiro-claude-sonnet-4", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Haiku 4.5 [Kiro]", "model": "kiro-claude-haiku-4.5", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" }
    ]
}
EOF

    if [ ! -f "$DROID_FILE" ]; then
        cp "/tmp/cliproxy_new_models.json" "$DROID_FILE"
        echo -e "${GREEN}[OK] Droid config created.${NC}"
    else
        echo -e "${YELLOW}[!] config.json exists, checking for missing models...${NC}"

        # Download and use shared merge utility
        MERGE_UTIL="/tmp/merge_config_$$.go"
        if curl -fsSL "https://raw.githubusercontent.com/khmuhtadin/cliproxy-installer/main/merge-config.go" -o "$MERGE_UTIL"; then
            go run "$MERGE_UTIL" "$DROID_FILE" "/tmp/cliproxy_new_models.json"
            rm -f "$MERGE_UTIL"
        else
            echo -e "${RED}[Error] Failed to download config merger. Skipping model merge.${NC}"
        fi
    fi
    rm -f "/tmp/cliproxy_new_models.json"


    # CALL SHORTCUT SETUP
    setup_shortcuts

    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}  INSTALLATION SUCCESS!${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo "Restart your terminal or run 'source ~/.zshrc' to use shortcuts:"
    echo -e "  1. Login:  ${CYAN}cp-login${NC}"
    echo -e "  2. Start:  ${CYAN}cp-start${NC}"
    echo -e "  3. Stop:   ${CYAN}cp-stop${NC}"
    echo -e "  4. Update: ${CYAN}cp-update${NC} (Fetches latest core & installer)"
}

# --- Main Execution ---

if [[ "$1" == "-update" ]]; then
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}   Updating CLIProxy...${NC}"
    echo -e "${CYAN}========================================${NC}"
    if ! check_brew; then install_brew; fi
    install_dependencies
    install_cliproxy
    echo -e "${GREEN}Update complete!${NC}"
    exit 0
fi

# --- Main Menu ---

clear
echo -e "${CYAN}========================================${NC}"
echo -e "${CYAN}   CLIProxy macOS Installer Manager${NC}"
echo -e "${CYAN}========================================${NC}"
echo ""
echo "1. Install Homebrew (Required for Git/Go)"
echo "2. Install Git & Go (Via Homebrew)"
echo "3. Install / Update CLIProxy Core"
echo "4. FULL INSTALL (Recommended for first run)"
echo "5. Exit"
echo ""
read -p "Please select your choice (1-5): " choice

case $choice in
    1) install_brew ;;
    2) install_dependencies ;;
    3) install_cliproxy ;;
    4)
        if ! check_brew; then install_brew; fi
        install_dependencies
        install_cliproxy
        ;;
    5) exit 0 ;;
    *) echo "Invalid choice." ;;
esac
