#!/bin/bash

# ==============================================================================
# CLIProxy Universal Installer
# One Script to Rule Them All: macOS, Linux, Windows (Git Bash)
# ==============================================================================

# --- Colors ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# --- Helper Functions ---

detect_os() {
    OS="$(uname -s)"
    case "$OS" in
        Linux*)     echo "linux";;
        Darwin*)    echo "macos";;
        MINGW*|MSYS*|CYGWIN*) echo "windows";;
        *)          echo "unknown";;
    esac
}

check_brew() {
    if command -v brew &> /dev/null; then
        echo -e "${GREEN}[OK] Homebrew is installed.${NC}"
        return 0
    else
        return 1
    fi
}

install_brew() {
    echo -e "${YELLOW}Installing Homebrew...${NC}"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    if [[ -f "/opt/homebrew/bin/brew" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
    if [[ -f "/usr/local/bin/brew" ]]; then
        eval "$(/usr/local/bin/brew shellenv)"
    fi
}

install_dependencies() {
    PLATFORM=$(detect_os)
    
    if [ "$PLATFORM" == "macos" ]; then
        if ! check_brew; then
            echo -e "${RED}[Error] Homebrew is generally required for macOS setup to install Git/Go easily.${NC}"
            echo -e "${YELLOW}Attempting to install Homebrew...${NC}"
            install_brew
        fi
        
        echo -e "${YELLOW}Updating Homebrew...${NC}"
        brew update
        
        echo -e "${YELLOW}Checking Git...${NC}"
        brew install git || echo "Git already installed/updated."
        
        echo -e "${YELLOW}Checking Go...${NC}"
        brew install go || echo "Go already installed/updated."

        echo -e "${YELLOW}Checking Python3...${NC}"
        if ! command -v python3 &> /dev/null; then
            brew install python3
        else
            echo "Python3 already installed."
        fi
        pip3 install --quiet requests 2>/dev/null || python3 -m pip install --quiet requests 2>/dev/null

    elif [ "$PLATFORM" == "linux" ]; then
        echo -e "${YELLOW}Detected Linux. Installing dependencies...${NC}"
        if command -v apt-get &> /dev/null; then
            echo "Using apt-get..."
            sudo apt-get update
            sudo apt-get install -y git golang python3 python3-pip
            pip3 install --quiet requests 2>/dev/null || python3 -m pip install --quiet requests 2>/dev/null
        elif command -v dnf &> /dev/null; then
            echo "Using dnf..."
            sudo dnf install -y git golang python3 python3-pip
            pip3 install --quiet requests 2>/dev/null
        elif command -v pacman &> /dev/null; then
            echo "Using pacman..."
            sudo pacman -S --noconfirm git go python python-pip python-requests
        elif command -v zypper &> /dev/null; then
            echo "Using zypper..."
            sudo zypper install -y git go python3 python3-pip
            pip3 install --quiet requests 2>/dev/null
        elif command -v yum &> /dev/null; then
            echo "Using yum..."
            sudo yum install -y git golang python3 python3-pip
            pip3 install --quiet requests 2>/dev/null
        else
            echo -e "${YELLOW}[Warning] Could not detect package manager. Please ensure Git, Go, and Python3 are installed manually.${NC}"
        fi
    elif [ "$PLATFORM" == "windows" ]; then
        echo -e "${YELLOW}Detected Windows (Git Bash/MSYS). Checking dependencies...${NC}"
        
        if command -v git &> /dev/null; then
             echo -e "${GREEN}[OK] Git is installed.${NC}"
        else
             echo -e "${RED}[Error] Git not found.${NC}"
             echo "Please install Git for Windows: https://git-scm.com/download/win"
             exit 1
        fi

        if command -v go &> /dev/null; then
             echo -e "${GREEN}[OK] Go is installed.${NC}"
        else
             echo -e "${RED}[Error] Go not found.${NC}"
             echo "Please install Go for Windows: https://go.dev/dl/"
             echo "After installing, restart your terminal and try again."
             exit 1
        fi

        if command -v python3 &> /dev/null || command -v python &> /dev/null; then
             echo -e "${GREEN}[OK] Python is installed.${NC}"
             pip install --quiet requests 2>/dev/null || python -m pip install --quiet requests 2>/dev/null
        else
             echo -e "${YELLOW}[Warning] Python not found. Quota fetcher will not work.${NC}"
             echo "Please install Python: https://www.python.org/downloads/"
        fi
    else
        echo -e "${RED}[Error] Unknown operating system: $(uname -s)${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}[OK] Dependencies ready.${NC}"
}

setup_shortcuts() {
    SHELL_CONFIG="$HOME/.zshrc"
    if [ "$SHELL" == "/bin/bash" ]; then
        SHELL_CONFIG="$HOME/.bashrc"
    fi

    echo -e "${YELLOW}Adding shortcuts to $SHELL_CONFIG...${NC}"

    # Remove old aliases if they exist to prevent duplicates
    PLATFORM=$(detect_os)
    if [ "$PLATFORM" == "macos" ]; then
        sed -i '' '/alias cp-login/d' "$SHELL_CONFIG" 2>/dev/null || true
        sed -i '' '/alias cp-start/d' "$SHELL_CONFIG" 2>/dev/null || true
        sed -i '' '/alias cp-update/d' "$SHELL_CONFIG" 2>/dev/null || true
        sed -i '' '/alias cp-stop/d' "$SHELL_CONFIG" 2>/dev/null || true
        sed -i '' '/alias cp-claude/d' "$SHELL_CONFIG" 2>/dev/null || true
        sed -i '' '/alias cp-db/d' "$SHELL_CONFIG" 2>/dev/null || true
    else
        # Linux & Windows (Git Bash has standard sed usually)
        sed -i '/alias cp-login/d' "$SHELL_CONFIG" 2>/dev/null || true
        sed -i '/alias cp-start/d' "$SHELL_CONFIG" 2>/dev/null || true
        sed -i '/alias cp-update/d' "$SHELL_CONFIG" 2>/dev/null || true
        sed -i '/alias cp-stop/d' "$SHELL_CONFIG" 2>/dev/null || true
        sed -i '/alias cp-claude/d' "$SHELL_CONFIG" 2>/dev/null || true
        sed -i '/alias cp-db/d' "$SHELL_CONFIG" 2>/dev/null || true
    fi

    # Remove old cp-db from /usr/local/bin if exists (legacy location)
    if [ -f "/usr/local/bin/cp-db" ]; then
        rm -f "/usr/local/bin/cp-db" 2>/dev/null || sudo rm -f "/usr/local/bin/cp-db" 2>/dev/null || true
    fi

    # Add new aliases
    echo "" >> "$SHELL_CONFIG"
    echo "# CLIProxy Shortcuts" >> "$SHELL_CONFIG"
    echo "alias cp-login=\"$HOME/.cli-proxy-api/scripts/login.sh\"" >> "$SHELL_CONFIG"
    echo "alias cp-start=\"$HOME/.cli-proxy-api/scripts/start.sh\"" >> "$SHELL_CONFIG"
    echo "alias cp-update=\"curl -sL https://raw.githubusercontent.com/khmuhtadin/cliproxy-installer/main/install | bash -s -- -update\"" >> "$SHELL_CONFIG"
    echo "alias cp-stop=\"$HOME/.cli-proxy-api/scripts/stop.sh\"" >> "$SHELL_CONFIG"
    echo "alias cp-claude=\"$HOME/.cli-proxy-api/scripts/cp-claude.sh\"" >> "$SHELL_CONFIG"
    echo "alias cp-db=\"$HOME/bin/cp-db\"" >> "$SHELL_CONFIG"

    echo -e "${GREEN}[OK] Shortcuts added.${NC}"
}

install_claude_statusline() {
    echo -e "${YELLOW}>>> Installing Claude Statusline...${NC}"
    
    PLATFORM=$(detect_os)
    STATUSLINE_DIR="$HOME/Scripts/claude-statusline"
    CLAUDE_SETTINGS="$HOME/.claude/settings.json"
    
    # Check for jq dependency
    if ! command -v jq &> /dev/null; then
        echo -e "${YELLOW}[!] jq is required for Claude Statusline${NC}"
        
        if [ "$PLATFORM" == "macos" ]; then
            echo "Installing jq via Homebrew..."
            brew install jq
        elif [ "$PLATFORM" == "linux" ]; then
            echo "Installing jq..."
            if command -v apt-get &> /dev/null; then
                sudo apt-get install -y jq
            elif command -v dnf &> /dev/null; then
                sudo dnf install -y jq
            elif command -v pacman &> /dev/null; then
                sudo pacman -S --noconfirm jq
            elif command -v yum &> /dev/null; then
                sudo yum install -y jq
            else
                echo -e "${RED}[Error] Could not install jq. Please install it manually.${NC}"
                return 1
            fi
        elif [ "$PLATFORM" == "windows" ]; then
            echo -e "${YELLOW}Please install jq manually:${NC}"
            echo "  - Using Chocolatey: choco install jq"
            echo "  - Using Scoop: scoop install jq"
            echo "  - Or download from: https://jqlang.github.io/jq/download/"
            return 1
        fi
    fi
    
    # Create directory
    mkdir -p "$STATUSLINE_DIR"
    
    # Download statusline files from GitHub
    echo "Downloading statusline script..."
    if curl -fsSL "https://raw.githubusercontent.com/galpratama/claude-statusline/main/statusline-command.sh" -o "$STATUSLINE_DIR/statusline-command.sh"; then
        chmod +x "$STATUSLINE_DIR/statusline-command.sh"
        echo -e "${GREEN}[OK] statusline-command.sh downloaded${NC}"
    else
        echo -e "${RED}[Error] Failed to download statusline-command.sh${NC}"
        return 1
    fi
    
    echo "Downloading statusline config..."
    if curl -fsSL "https://raw.githubusercontent.com/galpratama/claude-statusline/main/statusline-config.json" -o "$STATUSLINE_DIR/statusline-config.json"; then
        echo -e "${GREEN}[OK] statusline-config.json downloaded${NC}"
    else
        echo -e "${RED}[Error] Failed to download statusline-config.json${NC}"
        return 1
    fi
    
    # Set permissions
    chmod +x "$STATUSLINE_DIR/statusline-command.sh"
    
    # Configure Claude Code settings
    mkdir -p "$HOME/.claude"
    
    if [ -f "$CLAUDE_SETTINGS" ]; then
        # Backup existing settings
        cp "$CLAUDE_SETTINGS" "$CLAUDE_SETTINGS.backup"
        echo -e "${YELLOW}[!] Backed up existing settings.json${NC}"
        
        # Merge statusLine config
        if jq '. + {"statusLine": {"command": "/bin/bash $HOME/Scripts/claude-statusline/statusline-command.sh", "type": "command"}}' \
            "$CLAUDE_SETTINGS" > "$CLAUDE_SETTINGS.tmp" 2>/dev/null; then
            mv "$CLAUDE_SETTINGS.tmp" "$CLAUDE_SETTINGS"
            echo -e "${GREEN}[OK] Updated settings.json with statusLine config${NC}"
        else
            echo -e "${RED}[Error] Failed to update settings.json${NC}"
            rm -f "$CLAUDE_SETTINGS.tmp"
            return 1
        fi
    else
        # Create new settings file
        cat > "$CLAUDE_SETTINGS" <<'EOF'
{
  "statusLine": {
    "command": "/bin/bash $HOME/Scripts/claude-statusline/statusline-command.sh",
    "type": "command"
  }
}
EOF
        echo -e "${GREEN}[OK] Created settings.json with statusLine config${NC}"
    fi
    
    # Test the statusline
    echo "Testing statusline..."
    if bash "$STATUSLINE_DIR/statusline-command.sh" < /dev/null 2>/dev/null; then
        echo -e "${GREEN}[OK] Statusline script works!${NC}"
    else
        echo -e "${YELLOW}[!] Statusline test had issues (may need jq)${NC}"
    fi
    
    echo -e "${GREEN}[OK] Claude Statusline installed!${NC}"
    echo "    Restart Claude Code to see the statusline."
}

install_superpowers() {
    echo -e "${YELLOW}>>> Installing Superpowers for Claude Code...${NC}"

    # Check if claude command exists
    if ! command -v claude &> /dev/null; then
        echo -e "${RED}[Error] Claude Code not found. Please install Claude Code first.${NC}"
        return 1
    fi

    echo "This will run Claude Code to install the Superpowers plugin."
    echo ""
    echo "After Claude Code opens, the installer will automatically run:"
    echo "  1. /plugin marketplace add obra/superpowers-marketplace"
    echo "  2. /plugin install superpowers@superpowers-marketplace"
    echo ""

    # Create a temporary script that Claude will execute
    SUPERPOWERS_INSTALL_CMD='echo "Installing Superpowers plugin..." && claude -p "/plugin marketplace add obra/superpowers-marketplace" && sleep 2 && claude -p "/plugin install superpowers@superpowers-marketplace"'

    # Run the plugin commands
    echo "Running: /plugin marketplace add obra/superpowers-marketplace"
    if claude -p "/plugin marketplace add obra/superpowers-marketplace" 2>/dev/null; then
        echo -e "${GREEN}[OK] Marketplace added${NC}"
    else
        echo -e "${YELLOW}[!] Marketplace may already be added or command failed${NC}"
    fi

    sleep 1

    echo "Running: /plugin install superpowers@superpowers-marketplace"
    if claude -p "/plugin install superpowers@superpowers-marketplace" 2>/dev/null; then
        echo -e "${GREEN}[OK] Superpowers plugin installed${NC}"
    else
        echo -e "${YELLOW}[!] Plugin install may have failed. Try manually:${NC}"
        echo "    claude"
        echo "    /plugin marketplace add obra/superpowers-marketplace"
        echo "    /plugin install superpowers@superpowers-marketplace"
        return 1
    fi

    echo ""
    echo -e "${GREEN}[OK] Superpowers installed!${NC}"
    echo "    Verify with: claude, then type /help"
    echo "    You should see /superpowers:brainstorm, /superpowers:write-plan, etc."
}

install_cliproxy() {
    SKIP_OPTIONAL="${1:-false}"
    PLATFORM=$(detect_os)
    
    if ! command -v go &> /dev/null; then
        echo -e "${RED}[Error] Go is not found!${NC}"
        echo "Please install dependencies first."
        exit 1
    fi

    echo -e "${YELLOW}>>> Starting CLIProxy Installation...${NC}"

    BIN_DIR="$HOME/bin"
    CONFIG_DIR="$HOME/.cli-proxy-api"
    SCRIPTS_DIR="$CONFIG_DIR/scripts"

    mkdir -p "$BIN_DIR"
    mkdir -p "$CONFIG_DIR"
    mkdir -p "$SCRIPTS_DIR"
    STATIC_DIR="$CONFIG_DIR/static"
    mkdir -p "$STATIC_DIR"

    # Copy enhanced dashboard
    echo "Installing enhanced dashboard..."
    DASHBOARD_SRC="$(dirname "$0")/assets/static/dashboard.html"
    if [ -f "$DASHBOARD_SRC" ]; then
        cp "$DASHBOARD_SRC" "$STATIC_DIR/dashboard.html"
        echo -e "${GREEN}[OK] Dashboard installed from local assets${NC}"
    else
        # Fallback to download
        if curl -fsSL "https://raw.githubusercontent.com/khmuhtadin/cliproxy-installer/main/assets/static/dashboard.html" -o "$STATIC_DIR/dashboard.html" 2>/dev/null; then
            echo -e "${GREEN}[OK] Dashboard downloaded from GitHub${NC}"
        else
            echo -e "${YELLOW}[!] Could not install dashboard${NC}"
        fi
    fi

    # Install cp-db command
    echo "Installing cp-db feature..."
    
    # Determine dashboard open command
    OPEN_CMD="open" # macOS default
    if [ "$PLATFORM" == "linux" ]; then
        if command -v xdg-open >/dev/null 2>&1; then
            OPEN_CMD="xdg-open"
        elif command -v gnome-open >/dev/null 2>&1; then
            OPEN_CMD="gnome-open"
        else
            OPEN_CMD="echo 'Please open manually: '"
        fi
    elif [ "$PLATFORM" == "windows" ]; then
        OPEN_CMD="start"
    fi

    cat > "/tmp/cp-db" <<EOF
#!/bin/bash

# CLIProxy Dashboard Launcher
DASHBOARD_URL="http://localhost:8317/dashboard.html"
PORT=8317
QUOTA_FETCHER="\$HOME/.cli-proxy-api/scripts/quota-fetcher.py"

echo "CLIProxy Dashboard Launcher"
echo ""

# Check if server is already running
if lsof -i :\$PORT -sTCP:LISTEN -t >/dev/null 2>&1; then
    PID=\$(lsof -i :\$PORT -sTCP:LISTEN -t)
    echo "Server already running (PID: \$PID)"
else
    echo "Server not running, starting now..."

    CP_START_CMD=""
    if command -v cp-start >/dev/null 2>&1; then
        CP_START_CMD="cp-start"
    elif [ -x "\$HOME/.cli-proxy-api/scripts/start.sh" ]; then
        CP_START_CMD="\$HOME/.cli-proxy-api/scripts/start.sh"
    fi

    if [ -n "\$CP_START_CMD" ]; then
        "\$CP_START_CMD" >/dev/null 2>&1 &
        echo "Waiting for server to start..."

        for i in {1..10}; do
            sleep 1
            if lsof -i :\$PORT -sTCP:LISTEN -t >/dev/null 2>&1; then
                echo "Server started successfully"
                break
            fi
            if [ \$i -eq 10 ]; then
                echo "Server failed to start."
                exit 1
            fi
        done
    else
        echo "cp-start command not found."
        exit 1
    fi
fi

# Run quota fetcher to update dashboard data
if [ -f "\$QUOTA_FETCHER" ] && command -v python3 >/dev/null 2>&1; then
    echo "Fetching quota data..."
    python3 "\$QUOTA_FETCHER" 2>/dev/null
    echo "Quota data updated."
fi

# Setup cron job if not exists
CRON_CMD="*/10 * * * * /usr/bin/python3 \$HOME/.cli-proxy-api/scripts/quota-fetcher.py >/dev/null 2>&1"
if ! crontab -l 2>/dev/null | grep -q "quota-fetcher.py"; then
    (crontab -l 2>/dev/null; echo "\$CRON_CMD") | crontab - 2>/dev/null
    echo "Cron job added (auto-refresh every 10 min)"
fi

echo ""
echo "Opening dashboard: \$DASHBOARD_URL"
echo ""

$OPEN_CMD "\$DASHBOARD_URL" >/dev/null 2>&1
echo "Dashboard launcher finished."
EOF

    # Install cp-db to BIN_DIR instead of /usr/local/bin (no sudo required) to avoid Windows permission issues
    mv /tmp/cp-db "$BIN_DIR/cp-db"
    chmod +x "$BIN_DIR/cp-db"
    
    # Add BIN_DIR to path in shortcuts if not present, but for now we assume user adds it or run aliases
    # We can also alias cp-db in setup_shortcuts to point to $HOME/bin/cp-db to be safe
    
    echo -e "${GREEN}[OK] cp-db installed to $BIN_DIR/cp-db${NC}"


    # Clone & Build
    TEMP_DIR=$(mktemp -d)
    echo "Cloning repository..."
    if ! git clone --depth 1 https://github.com/router-for-me/CLIProxyAPIPlus.git "$TEMP_DIR"; then
        echo -e "${RED}[Error] Failed to clone repository${NC}"
        rm -rf "$TEMP_DIR"
        exit 1
    fi

    echo "Building binary..."
    cd "$TEMP_DIR"
    
    BINARY_NAME="cliproxyapi-plus"
    if [ "$PLATFORM" == "windows" ]; then
        BINARY_NAME="cliproxyapi-plus.exe"
    fi
    
    if ! go build -o "$BINARY_NAME" ./cmd/server; then
        echo -e "${RED}[Error] Failed to build binary${NC}"
        cd -
        rm -rf "$TEMP_DIR"
        exit 1
    fi
    mv -f "$BINARY_NAME" "$BIN_DIR/$BINARY_NAME"
    cd -
    rm -rf "$TEMP_DIR"

    echo -e "${GREEN}[OK] Binary built and installed successfully.${NC}"

    # Config - Only create if it doesn't exist
    if [ ! -f "$CONFIG_DIR/config.yaml" ]; then
        cat > "$CONFIG_DIR/config.yaml" <<EOF
port: 8317
auth-dir: "$CONFIG_DIR"
api-keys:
  - "sk-dummy"
remote-management:
  allow-remote: true
  secret-key: "$2a$10$RIbmiBCMENY/f/8cy0NkO.18.lgBIQEwThcOtm/g4y3G1AZ4Xlgjy"
quota-exceeded:
  switch-project: true
  switch-preview-model: true
EOF
        echo -e "${GREEN}[OK] Created config.yaml${NC}"
    else
        echo -e "${YELLOW}[!] config.yaml exists, preserving user settings${NC}"
    fi

    # Helper Scripts
    cat > "$SCRIPTS_DIR/start.sh" <<EOF
#!/bin/bash
echo "Starting CLIProxy on http://localhost:8317"
"$BIN_DIR/$BINARY_NAME" --config "$CONFIG_DIR/config.yaml"
EOF
    chmod +x "$SCRIPTS_DIR/start.sh"

    cat > "$SCRIPTS_DIR/login.sh" <<EOF
#!/bin/bash
BINARY="$BIN_DIR/$BINARY_NAME"
CONFIG="$CONFIG_DIR/config.yaml"
clear
echo "1. Antigravity (Claude/Gemini)"
echo "2. GitHub Copilot"
echo "3. Gemini CLI"
echo "4. Codex"
echo "5. Claude"
echo "6. Qwen"
echo "7. iFlow"
echo "8. Kiro"
read -p "Select provider (1-8): " c
case \$c in
  1) "\$BINARY" --config "\$CONFIG" -antigravity-login ;;
  2) "\$BINARY" --config "\$CONFIG" -github-copilot-login ;;
  3) "\$BINARY" --config "\$CONFIG" -login ;;
  4) "\$BINARY" --config "\$CONFIG" -codex-login ;;
  5) "\$BINARY" --config "\$CONFIG" -claude-login ;;
  6) "\$BINARY" --config "\$CONFIG" -qwen-login ;;
  7) "\$BINARY" --config "\$CONFIG" -iflow-login ;;
  8) "\$BINARY" --config "\$CONFIG" -kiro-login ;;
  *) echo "Invalid choice" ;;
esac
EOF
    chmod +x "$SCRIPTS_DIR/login.sh"
    
    # Stop Script
    cat > "$SCRIPTS_DIR/stop.sh" <<'EOF'
#!/bin/bash
# Stop CLIProxy server
PORT=8317

echo "Stopping CLIProxy server on port $PORT..."

# Find PID listening on port
if lsof -i :$PORT -sTCP:LISTEN -t >/dev/null 2>&1; then
    PID=$(lsof -i :$PORT -sTCP:LISTEN -t)
    echo "Found server process (PID: $PID)"
    kill $PID
    
    # Wait for process to stop
    sleep 1
    if lsof -i :$PORT -sTCP:LISTEN -t >/dev/null 2>&1; then
         echo "Force killing..."
         kill -9 $PID
    fi
    echo "Server stopped successfully"
else
    echo "Server is not running on port $PORT"
fi
EOF
    chmod +x "$SCRIPTS_DIR/stop.sh"

    # CP-Claude Script (Interactive + Auto-Start)
    cat > "$SCRIPTS_DIR/cp-claude.sh" <<'EOF'
#!/bin/bash

# Configuration
PROXY_URL="http://localhost:8317"
API_KEY="sk-dummy"
PORT=8317

# Export environment variables for Claude Code
export ANTHROPIC_BASE_URL="$PROXY_URL"
export ANTHROPIC_API_KEY="$API_KEY"

# If arguments are provided, pass them directly to claude
if [ "$#" -gt 0 ]; then
    exec claude "$@"
fi

# Function to check if server is running
check_server() {
    lsof -i :$PORT -sTCP:LISTEN -t >/dev/null 2>&1
    return $?
}

# Auto-start logic
if ! check_server; then
    echo "Server not running on port $PORT. Auto-starting..."
    
    # Determine start command
    CP_START_CMD=""
    if command -v cp-start >/dev/null 2>&1; then
        CP_START_CMD="cp-start"
    elif [ -x "$HOME/.cli-proxy-api/scripts/start.sh" ]; then
        CP_START_CMD="$HOME/.cli-proxy-api/scripts/start.sh"
    fi

    if [ -n "$CP_START_CMD" ]; then
        "$CP_START_CMD" >/dev/null 2>&1 &
        echo "Waiting for server..."
        
        # Wait up to 10 seconds
        for i in {1..10}; do
            sleep 1
            if check_server; then
                echo "Server started."
                break
            fi
            if [ $i -eq 10 ]; then
                echo "Failed to auto-start server."
                exit 1
            fi
        done
        sleep 1
    else
        echo "cp-start command not found. Cannot auto-start."
        exit 1
    fi
fi

# Interactive Mode
echo "Fetching available models..."

RESPONSE=$(curl -s -H "Authorization: Bearer $API_KEY" "$PROXY_URL/v1/models")

if [ $? -ne 0 ]; then
    echo "Failed to connect to proxy at $PROXY_URL"
    exit 1
fi

MODELS=$(echo "$RESPONSE" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    if 'data' in data:
        for model in data['data']:
            print(model['id'])
    else:
        print('ERROR: Invalid JSON format')
except Exception as e:
    print(f'ERROR: {e}')
")

if [[ "$MODELS" == ERROR* ]]; then
    echo "Failed to parse models."
    echo "Response: $RESPONSE"
    exit 1
fi

MODEL_ARRAY=($MODELS)

if [ ${#MODEL_ARRAY[@]} -eq 0 ]; then
    sleep 1
    RESPONSE=$(curl -s -H "Authorization: Bearer $API_KEY" "$PROXY_URL/v1/models")
    MODELS=$(echo "$RESPONSE" | python3 -c "import sys, json; print(' '.join([m['id'] for m in json.load(sys.stdin)['data']]))" 2>/dev/null)
    MODEL_ARRAY=($MODELS)
    
    if [ ${#MODEL_ARRAY[@]} -eq 0 ]; then
         echo "No models found."
         exit 1
    fi
fi

echo "Available Models:"
i=1
for model in "${MODEL_ARRAY[@]}"; do
    echo "  $i) $model"
    ((i++))
done

echo ""
read -p "Select model (1-${#MODEL_ARRAY[@]}): " selection

if [[ "$selection" =~ ^[0-9]+$ ]] && [ "$selection" -ge 1 ] && [ "$selection" -le "${#MODEL_ARRAY[@]}" ]; then
    SELECTED_MODEL="${MODEL_ARRAY[$((selection-1))]}"
    echo ""
    echo "Launching Claude Code with model: $SELECTED_MODEL"
    echo "   (Env: ANTHROPIC_BASE_URL=$ANTHROPIC_BASE_URL)"
    echo ""
    exec claude --model "$SELECTED_MODEL"
else
    echo "Invalid selection."
    exit 1
fi
EOF
    chmod +x "$SCRIPTS_DIR/cp-claude.sh"

    # Droid Config Injection
    DROID_FILE="$HOME/.factory/config.json"
    mkdir -p "$(dirname "$DROID_FILE")"

    # Define target models
    cat > "/tmp/cliproxy_new_models.json" <<EOF
{
    "custom_models": [
        { "model_display_name": "GPT-OSS 120B Medium [Antigravity]", "model": "gpt-oss-120b-medium", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "GPT-OSS 120B Large [Antigravity]", "model": "gpt-oss-120b-large", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Opus 4.5 Thinking [Antigravity]", "model": "gemini-claude-opus-4-5-thinking", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Sonnet 4.5 Thinking [Antigravity]", "model": "gemini-claude-sonnet-4-5-thinking", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Sonnet 4.5 [Antigravity]", "model": "gemini-claude-sonnet-4-5", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Gemini 3 Pro [Antigravity]", "model": "gemini-3-pro-preview", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Opus 4.5 [Copilot]", "model": "claude-opus-4.5", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "GPT-5 Mini [Copilot]", "model": "gpt-5-mini", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "GPT-5.1 Codex Max [Codex]", "model": "gpt-5.1-codex-max", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Gemini 3 Ultra [Antigravity]", "model": "gemini-3-ultra-preview", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Llama 4 405B [Meta]", "model": "llama-4-405b-instruct", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Nano Banana [Local]", "model": "nano-banana-v1", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Gemini 2.5 Pro [Gemini]", "model": "gemini-2.5-pro", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Qwen3 Coder Plus [Qwen]", "model": "qwen3-coder-plus", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "GLM 4.6 [iFlow]", "model": "glm-4.6", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Opus 4.5 [Kiro]", "model": "kiro-claude-opus-4.5", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Sonnet 4.5 [Kiro]", "model": "kiro-claude-sonnet-4.5", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Sonnet 4 [Kiro]", "model": "kiro-claude-sonnet-4", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" },
        { "model_display_name": "Claude Haiku 4.5 [Kiro]", "model": "kiro-claude-haiku-4.5", "base_url": "http://localhost:8317/v1", "api_key": "sk-dummy", "provider": "openai" }
    ]
}
EOF

    if [ ! -f "$DROID_FILE" ]; then
        cp "/tmp/cliproxy_new_models.json" "$DROID_FILE"
        echo -e "${GREEN}[OK] Droid config created.${NC}"
    else
        echo -e "${YELLOW}[!] config.json exists, checking for missing models...${NC}"

        MERGE_UTIL="/tmp/merge_config_$$.go"
        if curl -fsSL "https://raw.githubusercontent.com/khmuhtadin/cliproxy-installer/main/merge-config.go" -o "$MERGE_UTIL"; then
            go run "$MERGE_UTIL" "$DROID_FILE" "/tmp/cliproxy_new_models.json"
            rm -f "$MERGE_UTIL"
        else
            echo -e "${RED}[Error] Failed to download config merger. Skipping model merge.${NC}"
        fi
    fi
    rm -f "/tmp/cliproxy_new_models.json"

    # Download quota-fetcher.py and setup cron
    echo -e "${YELLOW}Setting up quota fetcher...${NC}"
    if curl -fsSL "https://raw.githubusercontent.com/khmuhtadin/cliproxy-installer/main/assets/scripts/quota-fetcher.py" -o "$SCRIPTS_DIR/quota-fetcher.py" 2>/dev/null; then
        chmod +x "$SCRIPTS_DIR/quota-fetcher.py"
        echo -e "${GREEN}[OK] Quota fetcher installed${NC}"

        # Setup cron job (every 10 minutes)
        CRON_CMD="*/10 * * * * /usr/bin/python3 $HOME/.cli-proxy-api/scripts/quota-fetcher.py >/dev/null 2>&1"
        if ! crontab -l 2>/dev/null | grep -q "quota-fetcher.py"; then
            (crontab -l 2>/dev/null; echo "$CRON_CMD") | crontab -
            echo -e "${GREEN}[OK] Cron job added (runs every 10 min)${NC}"
        fi
    fi

    setup_shortcuts

    # Skip optional installs if in update mode
    if [ "$SKIP_OPTIONAL" != "true" ]; then
        # Ask about optional Claude Statusline
        echo ""
        echo -e "${YELLOW}========================================${NC}"
        echo -e "${YELLOW}   Optional: Claude Statusline${NC}"
        echo -e "${YELLOW}========================================${NC}"
        echo "Claude Statusline displays AI model info, costs, git status,"
        echo "and development environment details in Claude Code."
        echo ""
        read -p "Install Claude Statusline? (y/n): " install_statusline

        if [[ "$install_statusline" =~ ^[Yy]$ ]]; then
            install_claude_statusline
        fi

        # Ask about optional Superpowers
        echo ""
        echo -e "${YELLOW}========================================${NC}"
        echo -e "${YELLOW}   Optional: Superpowers${NC}"
        echo -e "${YELLOW}========================================${NC}"
        echo "Superpowers adds advanced workflow skills to Claude Code:"
        echo "  - Brainstorming & spec refinement"
        echo "  - Implementation planning"
        echo "  - Subagent-driven development"
        echo "  - Test-driven development enforcement"
        echo ""
        read -p "Install Superpowers? (y/n): " install_superpowers_choice

        if [[ "$install_superpowers_choice" =~ ^[Yy]$ ]]; then
            install_superpowers
        fi
    fi

    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}  INSTALLATION SUCCESS!${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo "Restart your terminal or run source ~/.zshrc (or ~/.bashrc) to use shortcuts:"
    echo -e "  1. Login:  ${CYAN}cp-login${NC}"
    echo -e "  2. Start:  ${CYAN}cp-start${NC}"
    echo -e "  3. Stop:   ${CYAN}cp-stop${NC}"
    echo -e "  4. Update: ${CYAN}cp-update${NC} (Fetches latest core & installer)"
    echo -e "  5. Claude: ${CYAN}cp-claude${NC} (Runs Claude Code with Proxy)"
    echo -e "  6. DB:     ${CYAN}cp-db${NC}     (Open Dashboard)"
}

# --- Main Execution ---

if [[ "$1" == "-update" ]]; then
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}   CLIProxy Full Update${NC}"
    echo -e "${CYAN}========================================${NC}"
    echo ""

    # 1. Update Claude Code (auto-detect: brew cask, brew formula, or npm)
    echo -e "${YELLOW}>>> Updating Claude Code...${NC}"
    CLAUDE_UPDATED=false
    CLAUDE_INSTALL_METHOD="unknown"

    # Auto-detect installation method
    if command -v claude &> /dev/null; then
        CLAUDE_PATH=$(which claude)

        # Check if symlink points to Homebrew Caskroom
        if [[ -L "$CLAUDE_PATH" ]]; then
            CLAUDE_REAL_PATH=$(readlink "$CLAUDE_PATH" 2>/dev/null || readlink -f "$CLAUDE_PATH" 2>/dev/null)
            if [[ "$CLAUDE_REAL_PATH" == *"/Caskroom/"* ]]; then
                CLAUDE_INSTALL_METHOD="brew-cask"
            elif [[ "$CLAUDE_REAL_PATH" == *"/Cellar/"* ]]; then
                CLAUDE_INSTALL_METHOD="brew-formula"
            fi
        fi

        # Fallback: check npm if not detected via brew
        if [ "$CLAUDE_INSTALL_METHOD" = "unknown" ] && command -v npm &> /dev/null; then
            if npm list -g @anthropic-ai/claude-code &> /dev/null 2>&1; then
                CLAUDE_INSTALL_METHOD="npm"
            fi
        fi

        # Fallback: check brew list directly
        if [ "$CLAUDE_INSTALL_METHOD" = "unknown" ] && command -v brew &> /dev/null; then
            if brew list --cask claude-code &> /dev/null 2>&1; then
                CLAUDE_INSTALL_METHOD="brew-cask"
            elif brew list claude-code &> /dev/null 2>&1; then
                CLAUDE_INSTALL_METHOD="brew-formula"
            fi
        fi
    fi

    # Update based on detected method
    case "$CLAUDE_INSTALL_METHOD" in
        "brew-cask")
            echo "Detected: Claude Code installed via Homebrew Cask"
            # Get current and latest version
            CURRENT_VER=$(claude --version 2>/dev/null | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
            LATEST_VER=$(brew info --cask claude-code 2>/dev/null | grep -oE '^==> claude-code: [0-9]+\.[0-9]+\.[0-9]+' | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')

            if [ "$CURRENT_VER" = "$LATEST_VER" ]; then
                echo -e "${GREEN}[OK] Claude Code is already up to date (v$CURRENT_VER)${NC}"
            else
                echo "Updating from v$CURRENT_VER to v$LATEST_VER..."
                brew reinstall --cask claude-code
                echo -e "${GREEN}[OK] Claude Code updated to v$LATEST_VER (brew cask)${NC}"
            fi
            CLAUDE_UPDATED=true
            ;;
        "brew-formula")
            echo "Detected: Claude Code installed via Homebrew formula"
            if brew upgrade claude-code 2>&1 | tee /dev/stderr | grep -q "already installed"; then
                echo -e "${GREEN}[OK] Claude Code is already up to date${NC}"
            else
                echo -e "${GREEN}[OK] Claude Code updated (brew)${NC}"
            fi
            CLAUDE_UPDATED=true
            ;;
        "npm")
            echo "Detected: Claude Code installed via npm"
            npm update -g @anthropic-ai/claude-code
            echo -e "${GREEN}[OK] Claude Code updated (npm)${NC}"
            CLAUDE_UPDATED=true
            ;;
        *)
            if command -v claude &> /dev/null; then
                echo -e "${YELLOW}[!] Claude Code found but install method unknown${NC}"
                echo "    Path: $(which claude)"
                echo "    Please update manually via brew or npm"
            else
                echo -e "${YELLOW}[!] Claude Code not installed, skipping${NC}"
            fi
            ;;
    esac
    echo ""

    # 2. Update CLIProxy Core
    echo -e "${YELLOW}>>> Updating CLIProxy Core...${NC}"
    install_dependencies
    install_cliproxy "true"  # Skip optional prompts in update mode
    echo ""

    # 3. Update Claude Statusline (if installed)
    STATUSLINE_DIR="$HOME/Scripts/claude-statusline"
    if [ -d "$STATUSLINE_DIR" ]; then
        echo -e "${YELLOW}>>> Updating Claude Statusline...${NC}"
        if curl -fsSL "https://raw.githubusercontent.com/galpratama/claude-statusline/main/statusline-command.sh" -o "$STATUSLINE_DIR/statusline-command.sh"; then
            chmod +x "$STATUSLINE_DIR/statusline-command.sh"
            echo -e "${GREEN}[OK] statusline-command.sh updated${NC}"
        fi
        if curl -fsSL "https://raw.githubusercontent.com/galpratama/claude-statusline/main/statusline-config.json" -o "$STATUSLINE_DIR/statusline-config.json"; then
            echo -e "${GREEN}[OK] statusline-config.json updated${NC}"
        fi
        echo ""
    fi

    # 4. Update Dashboard and Scripts
    echo -e "${YELLOW}>>> Updating Dashboard...${NC}"
    STATIC_DIR="$HOME/.cli-proxy-api/static"
    SCRIPTS_DIR="$HOME/.cli-proxy-api/scripts"
    BIN_DIR="$HOME/bin"
    mkdir -p "$STATIC_DIR" "$SCRIPTS_DIR" "$BIN_DIR"
    if curl -fsSL "https://raw.githubusercontent.com/khmuhtadin/cliproxy-installer/main/assets/static/dashboard.html" -o "$STATIC_DIR/dashboard.html" 2>/dev/null; then
        echo -e "${GREEN}[OK] Dashboard updated${NC}"
    else
        echo -e "${YELLOW}[!] Could not update dashboard${NC}"
    fi
    if curl -fsSL "https://raw.githubusercontent.com/khmuhtadin/cliproxy-installer/main/assets/scripts/quota-fetcher.py" -o "$SCRIPTS_DIR/quota-fetcher.py" 2>/dev/null; then
        chmod +x "$SCRIPTS_DIR/quota-fetcher.py"
        echo -e "${GREEN}[OK] Quota fetcher script updated${NC}"

        # Setup cron job for quota fetcher (every 10 minutes)
        CRON_CMD="*/10 * * * * /usr/bin/python3 $HOME/.cli-proxy-api/scripts/quota-fetcher.py >/dev/null 2>&1"
        if ! crontab -l 2>/dev/null | grep -q "quota-fetcher.py"; then
            (crontab -l 2>/dev/null; echo "$CRON_CMD") | crontab -
            echo -e "${GREEN}[OK] Cron job added (runs every 10 min)${NC}"
        else
            echo -e "${CYAN}[i] Cron job already exists${NC}"
        fi
    fi

    # Update cp-db script
    PLATFORM=$(detect_os)
    if [ "$PLATFORM" == "macos" ]; then
        OPEN_CMD="open"
    elif [ "$PLATFORM" == "linux" ]; then
        OPEN_CMD="xdg-open"
    elif [ "$PLATFORM" == "windows" ]; then
        OPEN_CMD="start"
    fi

    cat > "$BIN_DIR/cp-db" <<CPDBEOF
#!/bin/bash

# CLIProxy Dashboard Launcher
DASHBOARD_URL="http://localhost:8317/dashboard.html"
PORT=8317
QUOTA_FETCHER="\$HOME/.cli-proxy-api/scripts/quota-fetcher.py"

echo "CLIProxy Dashboard Launcher"
echo ""

# Check if server is already running
if lsof -i :\$PORT -sTCP:LISTEN -t >/dev/null 2>&1; then
    PID=\$(lsof -i :\$PORT -sTCP:LISTEN -t)
    echo "Server already running (PID: \$PID)"
else
    echo "Server not running, starting now..."

    CP_START_CMD=""
    if command -v cp-start >/dev/null 2>&1; then
        CP_START_CMD="cp-start"
    elif [ -x "\$HOME/.cli-proxy-api/scripts/start.sh" ]; then
        CP_START_CMD="\$HOME/.cli-proxy-api/scripts/start.sh"
    fi

    if [ -n "\$CP_START_CMD" ]; then
        "\$CP_START_CMD" >/dev/null 2>&1 &
        echo "Waiting for server to start..."

        for i in {1..10}; do
            sleep 1
            if lsof -i :\$PORT -sTCP:LISTEN -t >/dev/null 2>&1; then
                echo "Server started successfully"
                break
            fi
            if [ \$i -eq 10 ]; then
                echo "Server failed to start."
                exit 1
            fi
        done
    else
        echo "cp-start command not found."
        exit 1
    fi
fi

# Run quota fetcher to update dashboard data
if [ -f "\$QUOTA_FETCHER" ] && command -v python3 >/dev/null 2>&1; then
    echo "Fetching quota data..."
    python3 "\$QUOTA_FETCHER" 2>/dev/null
    echo "Quota data updated."
fi

# Setup cron job if not exists
CRON_CMD="*/10 * * * * /usr/bin/python3 \$HOME/.cli-proxy-api/scripts/quota-fetcher.py >/dev/null 2>&1"
if ! crontab -l 2>/dev/null | grep -q "quota-fetcher.py"; then
    (crontab -l 2>/dev/null; echo "\$CRON_CMD") | crontab - 2>/dev/null
    echo "Cron job added (auto-refresh every 10 min)"
fi

echo ""
echo "Opening dashboard: \$DASHBOARD_URL"
echo ""

$OPEN_CMD "\$DASHBOARD_URL" >/dev/null 2>&1
echo "Dashboard launcher finished."
CPDBEOF
    chmod +x "$BIN_DIR/cp-db"
    echo -e "${GREEN}[OK] cp-db script updated${NC}"
    echo ""

    # 5. Update Superpowers (if installed)
    if command -v claude &> /dev/null; then
        # Check if superpowers plugin is installed by trying to update it
        echo -e "${YELLOW}>>> Updating Superpowers plugin...${NC}"
        if claude -p "/plugin update superpowers" 2>/dev/null; then
            echo -e "${GREEN}[OK] Superpowers updated${NC}"
        else
            echo -e "${YELLOW}[!] Superpowers not installed or update failed, skipping${NC}"
        fi
        echo ""
    fi

    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}   Full Update Complete!${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo "Updated components:"
    echo "  - Claude Code (npm/brew)"
    echo "  - CLIProxy Core (binary + scripts)"
    echo "  - Claude Statusline (if installed)"
    echo "  - Dashboard"
    echo "  - Superpowers plugin (if installed)"
    exit 0
fi

# --- Main Menu ---

clear
echo -e "${CYAN}========================================${NC}"
echo -e "${CYAN}   CLIProxy Universal Installer Manager${NC}"
echo -e "${CYAN}========================================${NC}"
echo ""
echo "Detected Platform: $(detect_os)"
echo ""
echo "1. Install Dependencies (Git & Go)"
echo "2. Install / Update CLIProxy Core"
echo "3. FULL INSTALL (Recommended for first run)"
echo "4. Exit"
echo ""
read -p "Please select your choice (1-4): " choice

case $choice in
    1) install_dependencies ;;
    2) install_cliproxy ;;
    3)
        install_dependencies
        install_cliproxy
        ;;
    4) exit 0 ;;
    *) echo "Invalid choice." ;;
esac
